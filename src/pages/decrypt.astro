---
import Layout from "@/layouts/Layout.astro";
import Container from "@/components/container.astro";
import { Icon } from "astro-icon/components";
---

<Layout title="Payment Details">
  <section class="py-16 min-h-[70vh] flex items-center">
    <Container>
      <div class="max-w-md mx-auto">
        <!-- Loading State -->
        <div id="loading-state" class="text-center">
          <div class="w-16 h-16 bg-gradient-to-br from-brand-green/20 to-emerald-100 rounded-2xl flex items-center justify-center mx-auto mb-4 animate-pulse">
            <Icon name="lucide:lock" class="w-8 h-8 text-brand-green" />
          </div>
          <h1 class="text-2xl font-bold text-gray-900 mb-2">Decrypting Payment Info</h1>
          <p class="text-gray-600">Please wait...</p>
        </div>

        <!-- Error State -->
        <div id="error-state" class="hidden">
          <div class="rounded-2xl bg-red-50 border border-red-200 p-8 text-center">
            <div class="w-16 h-16 bg-red-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
              <Icon name="lucide:alert-circle" class="w-8 h-8 text-red-500" />
            </div>
            <h1 class="text-2xl font-bold text-gray-900 mb-2">Unable to Decrypt</h1>
            <p class="text-gray-600 mb-4">The payment data could not be decrypted. The link may be invalid or corrupted.</p>
            <a href="/" class="inline-flex items-center gap-2 text-brand-green font-semibold hover:underline">
              <Icon name="lucide:arrow-left" class="w-4 h-4" />
              Return to Homepage
            </a>
          </div>
        </div>

        <!-- Success State -->
        <div id="success-state" class="hidden">
          <div class="rounded-2xl bg-white border border-gray-200 shadow-xl overflow-hidden">
            <!-- Header -->
            <div class="bg-gradient-to-r from-brand-green to-emerald-600 px-6 py-5 text-center">
              <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center mx-auto mb-3">
                <Icon name="lucide:credit-card" class="w-6 h-6 text-white" />
              </div>
              <h1 class="text-xl font-bold text-white">Payment Details</h1>
              <p id="customer-name" class="text-white/80 text-sm mt-1"></p>
            </div>

            <!-- Payment Info -->
            <div class="p-6 space-y-4">
              <div class="bg-gray-50 rounded-xl p-4">
                <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Cardholder Name</label>
                <p id="cardholder-name" class="text-gray-900 font-medium mt-1"></p>
              </div>

              <div class="bg-gray-50 rounded-xl p-4">
                <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Card Number</label>
                <p id="card-number" class="text-gray-900 font-mono text-lg font-medium mt-1"></p>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-50 rounded-xl p-4">
                  <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Expiry Date</label>
                  <p id="expiry-date" class="text-gray-900 font-mono font-medium mt-1"></p>
                </div>

                <div class="bg-gray-50 rounded-xl p-4">
                  <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider">CVV</label>
                  <p id="cvv" class="text-gray-900 font-mono font-medium mt-1"></p>
                </div>
              </div>

              <div class="bg-gray-50 rounded-xl p-4">
                <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Billing ZIP Code</label>
                <p id="zip-code" class="text-gray-900 font-medium mt-1"></p>
              </div>

              <div class="border-t border-gray-200 pt-4 mt-4">
                <p id="timestamp" class="text-xs text-gray-400 text-center"></p>
              </div>
            </div>

            <!-- Security Notice -->
            <div class="bg-amber-50 border-t border-amber-200 px-6 py-4">
              <div class="flex items-start gap-3">
                <Icon name="lucide:shield-alert" class="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" />
                <p class="text-xs text-amber-800">
                  This information is encrypted and can only be viewed with the correct decryption key.
                  Please enter it into MoeGo and do not share this link.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </Container>
  </section>
</Layout>

<script>
  async function decryptAndDisplay() {
    const loadingState = document.getElementById('loading-state');
    const errorState = document.getElementById('error-state');
    const successState = document.getElementById('success-state');

    // Get the encrypted data from URL
    const urlParams = new URLSearchParams(window.location.search);
    const encryptedData = urlParams.get('data');

    if (!encryptedData) {
      loadingState?.classList.add('hidden');
      errorState?.classList.remove('hidden');
      return;
    }

    try {
      const response = await fetch(`/api/decrypt?data=${encodeURIComponent(encryptedData)}`);
      const result = await response.json();

      if (result.success && result.data) {
        const data = result.data;

        // Populate the fields
        document.getElementById('customer-name')!.textContent = data.customerName || '';
        document.getElementById('cardholder-name')!.textContent = data.cardholderName || '';
        document.getElementById('card-number')!.textContent = data.cardNumber || '';
        document.getElementById('expiry-date')!.textContent = data.expiryDate || '';
        document.getElementById('cvv')!.textContent = data.cvv || '';
        document.getElementById('zip-code')!.textContent = data.zipCode || '';

        // Format timestamp
        if (data.timestamp) {
          const date = new Date(data.timestamp);
          document.getElementById('timestamp')!.textContent = `Submitted on ${date.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: 'numeric',
            minute: '2-digit'
          })}`;
        }

        loadingState?.classList.add('hidden');
        successState?.classList.remove('hidden');
      } else {
        loadingState?.classList.add('hidden');
        errorState?.classList.remove('hidden');
      }
    } catch (error) {
      loadingState?.classList.add('hidden');
      errorState?.classList.remove('hidden');
    }
  }

  // Run on page load
  decryptAndDisplay();
</script>
