let M=0;const x=document.querySelectorAll(".banner-slide"),W=document.querySelectorAll(".slider-dot"),ie=document.getElementById("prev-slide"),le=document.getElementById("next-slide");function q(t){x.forEach((e,n)=>{n===t?e.classList.remove("hidden"):e.classList.add("hidden")}),W.forEach((e,n)=>{n===t?(e.classList.remove("bg-white/40"),e.classList.add("bg-white/80")):(e.classList.remove("bg-white/80"),e.classList.add("bg-white/40"))}),M=t}function P(){q((M+1)%x.length)}function me(){q((M-1+x.length)%x.length)}let D=setInterval(P,5e3);function T(){clearInterval(D),D=setInterval(P,5e3)}ie?.addEventListener("click",()=>{me(),T()});le?.addEventListener("click",()=>{P(),T()});W.forEach((t,e)=>{t.addEventListener("click",()=>{q(e),T()})});let d=JSON.parse(localStorage.getItem("lillianruff-cart")||"[]"),I=null,l=1;const Y=document.getElementById("search-input"),C=document.querySelectorAll(".category-btn"),X=document.getElementById("sort-select"),Z=document.getElementById("products-grid"),F=document.querySelectorAll(".product-card"),ue=document.getElementById("no-results"),H=document.getElementById("product-count"),S=document.getElementById("cart-button"),g=document.getElementById("cart-count"),A=document.getElementById("cart-overlay"),ee=document.getElementById("cart-sidebar"),ge=document.getElementById("close-cart"),ye=document.getElementById("continue-shopping"),E=document.getElementById("cart-items-list"),z=document.getElementById("empty-cart"),_=document.getElementById("cart-footer"),Q=document.getElementById("cart-subtotal"),U=document.getElementById("cart-total"),N=document.getElementById("cart-item-count"),te=document.getElementById("product-modal"),pe=document.getElementById("modal-backdrop"),he=document.getElementById("close-modal"),fe=document.getElementById("checkout-btn"),ne=document.getElementById("checkout-modal"),ve=document.getElementById("checkout-backdrop"),Ee=document.getElementById("close-checkout"),V=document.getElementById("toast"),J=document.getElementById("toast-message"),y=document.getElementById("option-delivery"),p=document.getElementById("option-pickup"),se=document.getElementById("delivery-address-section"),oe=document.getElementById("pickup-address-section"),Le=document.getElementById("discount-code"),xe=document.getElementById("apply-discount"),i=document.getElementById("discount-message"),ae=window.productsData||[];let j="delivery",k=null;m();y?.addEventListener("click",()=>{j="delivery",y.classList.remove("border-gray-200","bg-white","text-gray-700"),y.classList.add("border-gray-900","bg-gray-900","text-white"),p?.classList.remove("border-gray-900","bg-gray-900","text-white"),p?.classList.add("border-gray-200","bg-white","text-gray-700"),se?.classList.remove("hidden"),oe?.classList.add("hidden"),m()});p?.addEventListener("click",()=>{j="pickup",p.classList.remove("border-gray-200","bg-white","text-gray-700"),p.classList.add("border-gray-900","bg-gray-900","text-white"),y?.classList.remove("border-gray-900","bg-gray-900","text-white"),y?.classList.add("border-gray-200","bg-white","text-gray-700"),se?.classList.add("hidden"),oe?.classList.remove("hidden"),m()});xe?.addEventListener("click",()=>{const t=Le?.value?.trim().toUpperCase();if(!t)return;const e={WELCOME10:{type:"percent",value:10,label:"10% off"},SAVE20:{type:"percent",value:20,label:"20% off"},FIRST5:{type:"fixed",value:5,label:"$5 off"}};e[t]?(k={code:t,...e[t]},i?.classList.remove("hidden","text-red-500"),i?.classList.add("text-green-600"),i&&(i.textContent=`âœ“ ${k.label} applied!`),m()):(k=null,i?.classList.remove("hidden","text-green-600"),i?.classList.add("text-red-500"),i&&(i.textContent="Invalid discount code"))});Y?.addEventListener("input",O);C.forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.category;C.forEach(n=>{const s=n.dataset.category===e;n.classList.contains("border")?(n.classList.remove("bg-brand-green","text-white","border-brand-green","bg-white","border-gray-200","text-gray-700"),s?n.classList.add("bg-brand-green","text-white","border-brand-green"):n.classList.add("bg-white","border-gray-200","text-gray-700")):(n.classList.remove("bg-gradient-to-r","from-brand-green","to-emerald-500","text-white","shadow-md","shadow-brand-green/30","bg-gray-50","text-gray-600"),s?n.classList.add("bg-gradient-to-r","from-brand-green","to-emerald-500","text-white","shadow-md","shadow-brand-green/30"):n.classList.add("bg-gray-50","text-gray-600"))}),O()})});X?.addEventListener("change",ke);F.forEach(t=>{t.addEventListener("click",e=>{if(e.target.closest(".quick-add")||e.target.closest(".add-to-cart"))return;const n=parseInt(t.dataset.productId);Me(n)})});document.querySelectorAll(".quick-add, .add-to-cart").forEach(t=>{t.addEventListener("click",e=>{e.stopPropagation();const n=parseInt(t.dataset.productId);de(n,1)})});S?.addEventListener("click",$e);ge?.addEventListener("click",h);ye?.addEventListener("click",h);A?.addEventListener("click",h);he?.addEventListener("click",w);pe?.addEventListener("click",w);document.getElementById("qty-decrease")?.addEventListener("click",()=>{l>1&&(l--,document.getElementById("modal-qty").textContent=l)});document.getElementById("qty-increase")?.addEventListener("click",()=>{l++,document.getElementById("modal-qty").textContent=l});document.getElementById("modal-add-to-cart")?.addEventListener("click",()=>{I&&(de(I.id,l),w())});fe?.addEventListener("click",qe);Ee?.addEventListener("click",b);ve?.addEventListener("click",b);document.getElementById("toggle-order-details")?.addEventListener("click",()=>{const t=document.getElementById("checkout-items"),e=document.getElementById("toggle-chevron");t?.classList.contains("hidden")?(t.classList.remove("hidden"),e?.classList.add("rotate-180")):(t?.classList.add("hidden"),e?.classList.remove("rotate-180"))});document.getElementById("retry-payment")?.addEventListener("click",()=>{document.getElementById("payment-status")?.classList.add("hidden"),document.getElementById("payment-error")?.classList.add("hidden"),document.getElementById("payment-form")?.classList.remove("hidden")});document.getElementById("close-success")?.addEventListener("click",()=>{b()});const Ie=window.SQUARE_APP_ID,Be=window.SQUARE_LOCATION_ID;let G=null,$=null;async function we(){if(!window.Square){const t=document.getElementById("payment-error-message");t&&(t.textContent="Payment system unavailable. Please try again later.");return}try{G=window.Square.payments(Ie,Be),$=await G.card(),await $.attach("#card-container")}catch{const e=document.getElementById("payment-error-message");e&&(e.textContent="Failed to initialize payment form. Please refresh and try again.")}}function R(){return d.reduce((t,e)=>t+e.price*e.quantity,0)}async function be(t){const e=document.getElementById("customer-email")?.value,n=R();document.getElementById("payment-form")?.classList.add("hidden"),document.getElementById("payment-status")?.classList.remove("hidden"),document.getElementById("payment-loading")?.classList.remove("hidden"),document.getElementById("payment-success")?.classList.add("hidden"),document.getElementById("payment-error")?.classList.add("hidden");try{const o=await(await fetch("/api/create-payment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sourceId:t,amount:n,currency:"USD",items:d,customerEmail:e})})).json();if(document.getElementById("payment-loading")?.classList.add("hidden"),o.success){if(document.getElementById("payment-success")?.classList.remove("hidden"),o.payment?.receiptUrl){const a=document.getElementById("receipt-link");a&&(a.innerHTML=`<a href="${o.payment.receiptUrl}" target="_blank" class="text-brand-green hover:underline">View Receipt</a>`)}d=[],B(),m()}else{document.getElementById("payment-error")?.classList.remove("hidden");const a=document.getElementById("error-message");a&&(a.textContent=o.error||"Payment failed. Please try again.")}}catch{document.getElementById("payment-loading")?.classList.add("hidden"),document.getElementById("payment-error")?.classList.remove("hidden");const o=document.getElementById("error-message");o&&(o.textContent="Network error. Please try again.")}}document.getElementById("card-pay-button")?.addEventListener("click",async()=>{if(!document.getElementById("customer-email")?.value){L("Please enter your email");return}const e=document.getElementById("card-pay-button");e&&(e.disabled=!0,e.querySelector("#pay-button-text").textContent="Processing...");try{const n=await $.tokenize();if(n.status==="OK")await be(n.token);else{let s="Card verification failed";n.errors&&(s=n.errors.map(o=>o.message).join(", ")),L(s)}}catch{L("Error processing card. Please try again.")}finally{e&&(e.disabled=!1,e.querySelector("#pay-button-text").textContent=`Pay $${R().toFixed(2)}`)}});function O(){const t=Y?.value.toLowerCase()||"",e=document.querySelector(".category-btn.bg-brand-green")?.dataset.category||"all";let n=0;F.forEach(s=>{const o=s.dataset.name,a=s.dataset.category;o.includes(t)&&(e==="all"||a===e)?(s.classList.remove("hidden"),n++):s.classList.add("hidden")}),H&&(H.innerHTML=`Showing <span class="font-bold text-gray-900">${n}</span> products`),ue?.classList.toggle("hidden",n>0),Z?.classList.toggle("hidden",n===0)}function ke(){const t=X?.value||"featured",e=Array.from(F);e.sort((n,s)=>{switch(t){case"price-low":return parseFloat(n.dataset.price)-parseFloat(s.dataset.price);case"price-high":return parseFloat(s.dataset.price)-parseFloat(n.dataset.price);case"name":return n.dataset.name.localeCompare(s.dataset.name);default:return 0}}),e.forEach(n=>Z?.appendChild(n))}function de(t,e=1){const n=ae.find(o=>o.id===t);if(!n)return;const s=d.find(o=>o.id===t);s?s.quantity+=e:d.push({id:n.id,name:n.name,price:n.price,image:n.image,size:n.size,quantity:e}),B(),m(),L("Added to cart!"),S?.classList.add("scale-125"),setTimeout(()=>S?.classList.remove("scale-125"),200)}function re(t){d=d.filter(e=>e.id!==t),B(),m()}function Ce(t,e){const n=d.find(s=>s.id===t);n&&(n.quantity+=e,n.quantity<=0?re(t):(B(),m()))}function B(){localStorage.setItem("lillianruff-cart",JSON.stringify(d))}function m(){const t=d.reduce((n,s)=>n+s.quantity,0),e=d.reduce((n,s)=>n+s.price*s.quantity,0);if(g&&(g.textContent=t>99?"99+":t.toString(),t>0?(g.classList.remove("opacity-0","scale-0"),g.classList.add("opacity-100","scale-100")):(g.classList.add("opacity-0","scale-0"),g.classList.remove("opacity-100","scale-100"))),N&&(N.textContent=`${t} item${t!==1?"s":""}`),t===0)z?.classList.remove("hidden"),E?.classList.add("hidden"),_?.classList.add("hidden");else{z?.classList.add("hidden"),E?.classList.remove("hidden"),_?.classList.remove("hidden"),E&&(E.innerHTML=d.map(c=>`
          <div class="flex gap-4 p-4 bg-gray-50 rounded-xl">
            <img src="${c.image}" alt="${c.name}" class="w-20 h-20 object-contain bg-white rounded-lg" />
            <div class="flex-1 min-w-0">
              <h4 class="font-bold text-gray-900 text-sm line-clamp-2">${c.name}</h4>
              <p class="text-xs text-gray-500">${c.size}</p>
              <div class="flex items-center justify-between mt-2">
                <div class="flex items-center gap-2">
                  <button onclick="updateQuantity(${c.id}, -1)" class="w-7 h-7 rounded-full bg-white border border-gray-200 flex items-center justify-center text-gray-500 hover:border-brand-green hover:text-brand-green">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg>
                  </button>
                  <span class="font-bold text-gray-900 w-6 text-center">${c.quantity}</span>
                  <button onclick="updateQuantity(${c.id}, 1)" class="w-7 h-7 rounded-full bg-white border border-gray-200 flex items-center justify-center text-gray-500 hover:border-brand-green hover:text-brand-green">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                  </button>
                </div>
                <span class="font-bold text-brand-green">$${(c.price*c.quantity).toFixed(2)}</span>
              </div>
            </div>
            <button onclick="removeFromCart(${c.id})" class="self-start text-gray-400 hover:text-red-500">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
          </div>
        `).join(""));const n=j==="pickup",s=n||e>=49.99?0:4.99,o=document.getElementById("cart-shipping"),a=document.getElementById("free-shipping-promo"),u=document.getElementById("shipping-row");if(u&&(n?u.classList.add("hidden"):u.classList.remove("hidden")),o&&!n&&(s===0?(o.textContent="FREE",o.classList.add("text-brand-green")):(o.textContent=`$${s.toFixed(2)}`,o.classList.remove("text-brand-green"))),a)if(n)a.innerHTML='<svg class="w-3.5 h-3.5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Pickup at spa - no shipping cost!',a.classList.remove("hidden");else if(e>0&&e<49.99){const c=(49.99-e).toFixed(2);a.innerHTML=`<svg class="w-3.5 h-3.5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg>Add $${c} more for FREE shipping!`,a.classList.remove("hidden")}else s===0?(a.innerHTML='<svg class="w-3.5 h-3.5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>You qualify for FREE shipping!',a.classList.remove("hidden")):a.classList.add("hidden");const r=(e+s)*.08875,v=document.getElementById("cart-tax");v&&(v.textContent=`$${r.toFixed(2)}`);const ce=e+s+r;Q&&(Q.textContent=`$${e.toFixed(2)}`),U&&(U.textContent=`$${ce.toFixed(2)}`)}}window.updateQuantity=Ce;window.removeFromCart=re;window.filterByCategory=Se;function Se(t){C.forEach(e=>{const n=e.dataset.category===t;e.classList.contains("border")?(e.classList.remove("bg-brand-green","text-white","border-brand-green","bg-white","border-gray-200","text-gray-700"),n?e.classList.add("bg-brand-green","text-white","border-brand-green"):e.classList.add("bg-white","border-gray-200","text-gray-700")):(e.classList.remove("bg-gradient-to-r","from-brand-green","to-emerald-500","text-white","shadow-md","shadow-brand-green/30","bg-gray-50","text-gray-600"),n?e.classList.add("bg-gradient-to-r","from-brand-green","to-emerald-500","text-white","shadow-md","shadow-brand-green/30"):e.classList.add("bg-gray-50","text-gray-600"))}),O(),document.getElementById("products")?.scrollIntoView({behavior:"smooth"})}function $e(){A?.classList.remove("opacity-0","pointer-events-none"),ee?.classList.remove("translate-x-full"),document.body.style.overflow="hidden"}function h(){A?.classList.add("opacity-0","pointer-events-none"),ee?.classList.add("translate-x-full"),document.body.style.overflow=""}function Me(t){const e=ae.find(o=>o.id===t);if(!e)return;I=e,l=1,document.getElementById("modal-image").src=e.image,document.getElementById("modal-image").alt=e.name,document.getElementById("modal-title").textContent=e.name,document.getElementById("modal-price").textContent=`$${e.price.toFixed(2)}`,document.getElementById("modal-description").textContent=e.description,document.getElementById("modal-size").textContent=e.size,document.getElementById("modal-reviews").textContent=`(${e.reviews} reviews)`,document.getElementById("modal-ingredients").textContent=e.ingredients,document.getElementById("modal-qty").textContent="1";const n=document.getElementById("modal-rating");n.innerHTML=[...Array(5)].map((o,a)=>`<svg class="w-4 h-4 ${a<Math.floor(e.rating)?"text-yellow-400 fill-yellow-400":"text-gray-300"}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path></svg>`).join("");const s=document.getElementById("modal-features");s.innerHTML=e.features.map(o=>`<li class="inline-flex items-center gap-1 px-2.5 py-1 bg-emerald-50 text-emerald-700 rounded-full text-xs font-medium">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
        ${o}
      </li>`).join(""),te?.classList.remove("opacity-0","pointer-events-none"),document.getElementById("modal-content")?.classList.remove("scale-95"),document.body.style.overflow="hidden"}function w(){te?.classList.add("opacity-0","pointer-events-none"),document.getElementById("modal-content")?.classList.add("scale-95"),document.body.style.overflow="",I=null,l=1}let K=!1;async function qe(){if(d.length===0)return;document.getElementById("payment-form")?.classList.remove("hidden"),document.getElementById("payment-status")?.classList.add("hidden"),document.getElementById("payment-loading")?.classList.add("hidden"),document.getElementById("payment-success")?.classList.add("hidden"),document.getElementById("payment-error")?.classList.add("hidden");const t=document.getElementById("checkout-items"),e=d.reduce((r,v)=>r+v.quantity,0);t&&(t.innerHTML=d.map(r=>`<div class="flex items-center gap-2 text-sm py-1">
          <span class="text-gray-400 text-xs w-5">${r.quantity}x</span>
          <span class="flex-1 text-gray-600 truncate text-xs">${r.name}</span>
          <span class="font-medium text-gray-900 text-xs">$${(r.price*r.quantity).toFixed(2)}</span>
        </div>`).join(""));const n=document.getElementById("checkout-item-count");n&&(n.textContent=e.toString());const s=document.getElementById("checkout-items"),o=document.getElementById("toggle-chevron");s?.classList.add("hidden"),o?.classList.remove("rotate-180");const a=R(),u=document.getElementById("checkout-total");u&&(u.textContent=`$${a.toFixed(2)}`);const f=document.getElementById("pay-button-text");f&&(f.textContent=`Pay $${a.toFixed(2)}`),h(),ne?.classList.remove("opacity-0","pointer-events-none"),setTimeout(()=>{const r=document.getElementById("checkout-content");r?.classList.remove("translate-y-full","md:scale-95"),r?.classList.add("translate-y-0","md:scale-100")},10),document.body.style.overflow="hidden",K||(await we(),K=!0)}function b(){const t=document.getElementById("checkout-content");t?.classList.add("translate-y-full","md:scale-95"),t?.classList.remove("translate-y-0","md:scale-100"),setTimeout(()=>{ne?.classList.add("opacity-0","pointer-events-none")},300),document.body.style.overflow=""}function L(t){J&&(J.textContent=t),V?.classList.remove("opacity-0","translate-y-4","pointer-events-none"),setTimeout(()=>{V?.classList.add("opacity-0","translate-y-4","pointer-events-none")},2e3)}document.addEventListener("keydown",t=>{t.key==="Escape"&&(w(),h(),b())});
